# hosts/hypervisor/default.nix
# Physical hypervisor host configuration
# Manages: ZFS storage, Tailscale, MicroVM lifecycle
{ config, pkgs, ... }:
{
  imports = [
    # Generated by: nixos-generate-config
    # Contains: boot.loader, fileSystems, hardware config
    ./hardware-configuration.nix

    # Network bridges, NAT, firewall
    ./network.nix

    # EBS volume management with ZFS
    ../../modules/ebs-volume
  ];

  networking.hostName = "hypervisor";

  # ZFS support
  boot.supportedFilesystems = [ "zfs" ];
  boot.zfs.forceImportRoot = false;

  # Required for ZFS (random 8-char hex string)
  # Generate with: head -c 4 /dev/urandom | od -A none -t x4 | tr -d ' '
  networking.hostId = "12345678";  # TODO: Generate unique ID

  # Tailscale for remote access and subnet routing
  services.tailscale.enable = true;

  # Basic system tools
  environment.systemPackages = with pkgs; [
    vim
    git
    htop
    tmux
    curl
    wget
  ];

  # SSH with key-only auth
  services.openssh = {
    enable = true;
    settings = {
      PermitRootLogin = "prohibit-password";
      PasswordAuthentication = false;
    };
  };

  # Allow wheel group to sudo without password (convenience)
  security.sudo.wheelNeedsPassword = false;

  # Create an admin user (customize as needed)
  users.users.admin = {
    isNormalUser = true;
    extraGroups = [ "wheel" "networkmanager" ];
    # Add your SSH public key here:
    # openssh.authorizedKeys.keys = [ "ssh-ed25519 AAAA..." ];
  };

  # EBS volume management with ZFS
  services.ebsVolumes = {
    enable = true;
    volumes."microvm-storage" = {
      mountPoint = "/var/lib/microvms";
      sizeGiB = 100;
      poolName = "microvm-pool";
      dataset = "storage";
      volumeType = "gp3";
      throughput = 125;  # MiB/s
      iops = 3000;
      encrypted = true;
      mountOptions = [ "nofail" "defaults" ];
      mountOwner = "root";
      mountGroup = "root";
      mountDirMode = "0755";
      device = "/dev/sdf";
    };
  };

  # NixOS version (don't change after initial install)
  system.stateVersion = "24.05";
}
